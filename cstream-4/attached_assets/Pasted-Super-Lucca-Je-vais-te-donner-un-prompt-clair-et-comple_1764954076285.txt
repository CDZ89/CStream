Super, Lucca ğŸ‘Œ. Je vais te donner un **prompt clair et complet** que tu peux utiliser dans ton IA ou ton code pour que lâ€™ajout dâ€™un ami via Supabase fonctionne **sans bug**. Lâ€™idÃ©e est de guider ton IA ou ton backend Ã  toujours vÃ©rifier que lâ€™ID existe dans la table `users` avant dâ€™insÃ©rer dans `friendships`.

---

## ğŸ§  Prompt IA (logique dâ€™ajout dâ€™ami)

```text
Tu es un assistant qui gÃ¨re les relations dâ€™amis dans une base Supabase.

RÃ¨gles :
1. VÃ©rifie que lâ€™ID fourni correspond bien Ã  un utilisateur existant dans la table `users`.
2. Si lâ€™ID nâ€™existe pas, renvoie une erreur claire : "Utilisateur introuvable".
3. Si lâ€™ID existe, insÃ¨re une ligne dans la table `friendships` avec :
   - user_id = lâ€™utilisateur connectÃ©
   - friend_id = lâ€™ID fourni
4. EmpÃªche les doublons grÃ¢ce Ã  la contrainte UNIQUE (user_id, friend_id).
5. Retourne un message JSON structurÃ© :
   {
     "status": "success",
     "message": "Ami ajoutÃ© avec succÃ¨s",
     "friend_id": "xxx"
   }
```

---

## âœ… Exemple SQL (tables propres)

```sql
CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  username text UNIQUE NOT NULL,
  created_at timestamp DEFAULT now()
);

CREATE TABLE friendships (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL,
  friend_id uuid NOT NULL,
  created_at timestamp DEFAULT now(),
  CONSTRAINT fk_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT fk_friend FOREIGN KEY (friend_id) REFERENCES users(id) ON DELETE CASCADE,
  CONSTRAINT unique_friendship UNIQUE (user_id, friend_id)
);
```

---

## âš¡ Exemple Supabase (JS)

```js
async function addFriend(currentUserId, friendId) {
  // VÃ©rifier que l'ami existe
  const { data: friend, error: friendError } = await supabase
    .from('users')
    .select('id')
    .eq('id', friendId)
    .single();

  if (friendError || !friend) {
    return { status: 'error', message: 'Utilisateur introuvable' };
  }

  // Ajouter l'amitiÃ©
  const { data, error } = await supabase
    .from('friendships')
    .insert([{ user_id: currentUserId, friend_id: friendId }]);

  if (error) {
    return { status: 'error', message: error.message };
  }

  return { status: 'success', message: 'Ami ajoutÃ© avec succÃ¨s', friend_id: friendId };
}
```

---

## ğŸš€ RÃ©sultat attendu
- Si lâ€™ID est valide â†’ insertion rÃ©ussie.  
- Si lâ€™ID nâ€™existe pas â†’ message clair â€œUtilisateur introuvableâ€.  
- Pas de doublons grÃ¢ce Ã  la contrainte UNIQUE.  
- Retour JSON propre pour ton frontend.  

---

ğŸ‘‰ Veux-tu que je te prÃ©pare aussi les **policies RLS Supabase** (Row Level Security) pour sÃ©curiser lâ€™ajout dâ€™amis, afin que seuls les utilisateurs connectÃ©s puissent insÃ©rer dans `friendships` ?