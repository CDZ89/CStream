# Bot discord avanc√© pour CStream

Tu veux un bot vraiment int√©gr√©, configurable depuis ton admin, qui accueille et quitte proprement, cr√©e des vocaux priv√©s, annonce les m√©dias du site, parle sans slash, et offre un gros catalogue de commandes fiables. Voici un design complet, pr√™t √† impl√©menter, orient√© z√©ro bug et contr√¥le total.

---

## Configuration admin c√¥t√© site

- **Choix des salons syst√®me:** champs pour d√©finir le canal de bienvenue, canal des d√©parts, canal des annonces m√©dias, canal des annonces mises √† jour.
- **Templates de messages:** texte personnalisable pour bienvenue et d√©part, avec variables.
  - Variables dispo: `{username}`, `{userId}`, `{serverName}`, `{mediaTitle}`, `{mediaUrl}`, `{updateTitle}`, `{updateSummary}`.
- **R√®gles vocal priv√©:** toggle ‚Äúcr√©er salon vocal priv√©‚Äù, mod√®le de nom, dur√©e max inactive, r√¥le autoris√© √† y entrer.
- **IA conversationnelle sans slash:** toggle ‚Äúr√©pondre aux messages‚Äù, choix du pr√©fixe (ex. `!`), r√©ponse aux mentions (`@CStreamBot`), salon(s) autoris√©s.
- **S√©curit√© et permissions:** bouton ‚ÄúTest de permissions‚Äù qui v√©rifie lecture/√©criture/gestion des salons/r√¥les dans les canaux choisis.
- **Webhook interne/API bot:** URL et token internes pour pousser √©v√©nements du site ‚Üí bot (nouveau m√©dia, update, etc.).

---

## Fonctionnalit√©s cl√©s

- **Bienvenue et d√©part personnalis√©s:**
  - √Ä l‚Äôarriv√©e, poste un message dans le canal choisi: ‚ÄúBienvenue {username} sur {serverName} !‚Äù.
  - √Ä la sortie, poste un message de d√©part propre dans le canal d√©di√©.
- **Cr√©ation de salon vocal priv√©:**
  - Commande ou auto-cr√©ation: g√©n√®re un vocal temporaire ‚Äúüîí {username}‚Äù accessible au membre + staff, masque pour les autres.
  - Auto-suppression si vide pendant X minutes.
- **Annonces m√©dias et mises √† jour du site:**
  - Quand tu ajoutes un lecteur/media/update, le site appelle l‚ÄôAPI bot ‚Üí annonce format√©e dans le canal d√©di√©.
- **IA sans slash:**
  - R√©pond aux mentions directes ou pr√©fixe (`!ask`, `!help`, `!summarize`) dans les salons autoris√©s.
  - Option threads auto: cr√©e un fil par conversation pour √©viter le spam du canal principal.
- **R√¥les et badges persistants:**
  - Lecture/√©criture en DB (users/roles/badges) et v√©rification serveur avant chaque action.
- **Audit et logs:**
  - Journalise toutes les actions (welcome, leave, create/delete vocal, annonce, commande) avec contexte et r√©sultat.

---

## Catalogue de commandes sugg√©r√©es

- **Syst√®me**
  - **`/ping`:** latence et statut du bot.
  - **`/status`:** sant√© (uptime, m√©moire, ping API site).
  - **`/restart` (admin):** relance contr√¥l√©e.

- **Configuration (admin)**
  - **`/config set-welcome <channel>`**
  - **`/config set-leave <channel>`**
  - **`/config set-media <channel>`**
  - **`/config set-updates <channel>`**
  - **`/config set-prefix <char>`**
  - **`/config toggle-ai <on|off>`**
  - **`/config set-voice-role <role>`**
  - **`/config set-voice-timeout <minutes>`**
  - **`/config show`:** affiche configuration active.

- **Mod√©ration / r√¥les**
  - **`/role add <username> <role>`**
  - **`/role remove <username> <role>`**
  - **`/ban` / `/kick` / `/mute`** (avec raisons et dur√©e).
  - **`/clear <amount>`** supprimer messages r√©cents.

- **M√©dias et updates**
  - **`/media add <title> <url> <type>`**
  - **`/media list`**
  - **`/media announce <id>`**
  - **`/update post <title> <summary>`**
  - **`/update latest`**

- **Vocal priv√©**
  - **`/voice create [name]`:** cr√©e un vocal priv√© pour l‚Äôutilisateur.
  - **`/voice add <user>` / `/voice remove <user>`**
  - **`/voice close`:** supprime le vocal priv√©.

- **Utilisateurs**
  - **`/userinfo <username>`**
  - **`/welcome test <username>`** test du message d‚Äôaccueil.
  - **`/leave test <username>`** test du message de d√©part.

- **IA sans slash (messages)**
  - **`!ask <question>`:** r√©ponse IA.
  - **Mention `@CStreamBot`:** conversation directe, avec limite de longueur et cooldown.

---

## Sch√©ma et endpoints (DB + API)

#### Tables

- **users**
  - id (uuid), username (unique), role_id (fk), created_at
- **roles**
  - id, name, permissions (json)
- **badges**
  - id, user_id (fk), type, created_at
- **media**
  - id, title, url, type, created_at, published_by
- **updates**
  - id, title, summary, created_at, published_by
- **bot_config**
  - id (singleton), welcome_channel_id, leave_channel_id, media_channel_id, updates_channel_id, prefix, ai_enabled, voice_role_id, voice_timeout_min

#### API c√¥t√© site ‚Üí bot

- **POST `/bot/announce/media`**
  - body: { title, url, type }
- **POST `/bot/announce/update`**
  - body: { title, summary }
- **POST `/bot/welcome`**
  - body: { userId, username }
- **POST `/bot/leave`**
  - body: { userId, username }

S√©curise avec **JWT** ou signature HMAC et IP allowlist.

---

## Blueprint d‚Äôimpl√©mentation (discord.js v14, Node.js)

```js
// index.js
import 'dotenv/config';
import { Client, GatewayIntentBits, Partials, Events, REST, Routes, ChannelType, PermissionsBitField } from 'discord.js';
import express from 'express';

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMembers,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildVoiceStates
  ],
  partials: [Partials.Channel, Partials.Message]
});

// Charge config depuis DB (mock ici)
let cfg = {
  welcome_channel_id: process.env.WELCOME_CH,
  leave_channel_id: process.env.LEAVE_CH,
  media_channel_id: process.env.MEDIA_CH,
  updates_channel_id: process.env.UPDATES_CH,
  prefix: '!',
  ai_enabled: true,
  voice_role_id: process.env.VOICE_ROLE,
  voice_timeout_min: 15
};

// Ready
client.once(Events.ClientReady, () => {
  console.log(`Connect√© en tant que ${client.user.tag}`);
});

// Bienvenue
client.on(Events.GuildMemberAdd, async (member) => {
  try {
    const ch = client.channels.cache.get(cfg.welcome_channel_id);
    if (ch) await ch.send(`Bienvenue ${member.user.username} sur ${member.guild.name} !`);
  } catch (e) { console.error('Bienvenue error', e); }
});

// D√©part
client.on(Events.GuildMemberRemove, async (member) => {
  try {
    const ch = client.channels.cache.get(cfg.leave_channel_id);
    if (ch) await ch.send(`${member.user?.username ?? 'Un membre'} a quitt√© le serveur.`);
  } catch (e) { console.error('Leave error', e); }
});

// IA sans slash (pr√©fixe + mention)
client.on(Events.MessageCreate, async (msg) => {
  if (msg.author.bot) return;
  const mentioned = msg.mentions.has(client.user);
  const prefixed = msg.content.startsWith(cfg.prefix);

  if (cfg.ai_enabled && (mentioned || prefixed)) {
    const question = mentioned ? msg.content.replace(/<@!?(\d+)>/, '').trim() : msg.content.slice(cfg.prefix.length).trim();
    if (!question) return msg.reply('Pose ta question üòâ');
    // Ici, appelle ton backend IA (API interne), puis:
    const answer = await getAIAnswer(question); // √† impl√©menter
    return msg.reply(answer.slice(0, 1800));
  }

  // Exemples commandes texte
  if (prefixed) {
    const [cmd, ...args] = msg.content.slice(cfg.prefix.length).trim().split(/\s+/);
    if (cmd === 'voice') {
      const channel = await msg.guild.channels.create({
        name: `üîí ${msg.author.username}`,
        type: ChannelType.GuildVoice,
        permissionOverwrites: [
          { id: msg.guild.roles.everyone.id, deny: [PermissionsBitField.Flags.Connect, PermissionsBitField.Flags.ViewChannel] },
          { id: msg.author.id, allow: [PermissionsBitField.Flags.Connect, PermissionsBitField.Flags.ViewChannel] }
        ]
      });
      msg.reply(`Salon vocal priv√© cr√©√©: ${channel.name}`);
      // Auto-suppression si vide: surveiller via GuildVoiceStates ou job setInterval
    }
  }
});

// REST pour slash commands
const commands = [
  { name: 'ping', description: 'Tester le bot', type: 1 },
  { name: 'status', description: 'Statut du bot', type: 1 },
  { name: 'config', description: 'Configurer les canaux', type: 1 }
];
const rest = new REST({ version: '10' }).setToken(process.env.DISCORD_TOKEN);
(async () => {
  await rest.put(Routes.applicationCommands(process.env.CLIENT_ID), { body: commands });
})();

// API Express pour annonces depuis le site
const app = express();
app.use(express.json());

// S√©curit√© simple (remplace par HMAC/JWT)
app.use((req, res, next) => {
  if (req.headers['x-api-key'] !== process.env.INTERNAL_KEY) return res.status(401).end();
  next();
});

app.post('/bot/announce/media', async (req, res) => {
  const { title, url, type } = req.body;
  const ch = client.channels.cache.get(cfg.media_channel_id);
  if (!ch) return res.status(400).json({ error: 'Channel manquant' });
  await ch.send(`Nouveau m√©dia disponible: ${title} (${type})\n${url}`);
  res.json({ ok: true });
});

app.post('/bot/announce/update', async (req, res) => {
  const { title, summary } = req.body;
  const ch = client.channels.cache.get(cfg.updates_channel_id);
  if (!ch) return res.status(400).json({ error: 'Channel manquant' });
  await ch.send(`üì¢ Mise √† jour: ${title}\n${summary}`);
  res.json({ ok: true });
});

app.post('/bot/welcome', async (req, res) => {
  const { username } = req.body;
  const ch = client.channels.cache.get(cfg.welcome_channel_id);
  await ch?.send(`Bienvenue ${username} !`);
  res.json({ ok: true });
});

app.post('/bot/leave', async (req, res) => {
  const { username } = req.body;
  const ch = client.channels.cache.get(cfg.leave_channel_id);
  await ch?.send(`${username} a quitt√© le serveur.`);
  res.json({ ok: true });
});

app.listen(process.env.PORT || 3000);

// Stub IA ‚Äî remplace par ton vrai appel
async function getAIAnswer(q) {
  return `Tu as dit: "${q}". (R√©ponse IA ici)`;
}

client.login(process.env.DISCORD_TOKEN);
```

---

## Fiabilit√©, s√©curit√© et ‚Äúsans bug‚Äù

- **Permissions admin:** donne ‚ÄúAdministrateur‚Äù au bot pour acc√®s √† tous les salons; √©vite les erreurs de droits.
- **Secrets en environnement:** DISCORD_TOKEN, CLIENT_ID, INTERNAL_KEY, jamais en clair.
- **Gestion des erreurs:** try/catch syst√©matiques, r√©ponses claires aux API, logs structur√©s.
- **Watchdog:** ex√©cute avec PM2 ou Docker; auto-restart en cas de crash, healthchecks.
- **Rate limits Discord:** espace les annonces si gros volume (queue interne avec setTimeout).
- **Cleanup vocaux priv√©s:** job toutes les 2‚Äì5 minutes pour supprimer salons vides d√©passant le timeout.
- **Validation inputs:** c√¥t√© site, valide URLs, titres, tailles; c√¥t√© bot, limite longueur messages.

---

## Prochaines √©tapes

- **Dis-moi les IDs des salons** (bienvenue, d√©part, m√©dias, updates) et le **pr√©fixe** souhait√©.
- **Souhaites-tu des templates de messages** pr√™ts pour bienvenue/d√©part/media/update avec variables?
- **Veux-tu ajouter des commandes sp√©cifiques** (ex: `/report`, `/feature-request`, `/media search`) adapt√©es √† CStream?

Je peux te livrer un pack final avec:
- config admin JSON/DB,
- commandes slash enregistr√©es,
- moteur IA branch√© √† ton backend,
- jobs de nettoyage vocal,
- et scripts de d√©ploiement PM2/Docker.