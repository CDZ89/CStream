Je comprends ta frustration Luccaâ€¯: ce type dâ€™erreur â€œProfil utilisateur non synchronisÃ©. Essayez de rafraÃ®chir la page.â€ est typique dâ€™une intÃ©gration Supabase oÃ¹ la logique authentification â†” base de donnÃ©es nâ€™est pas bien reliÃ©e.

ğŸ” Pourquoi Ã§a arrive
Auth vs. Database

Supabase gÃ¨re deux chosesâ€¯: lâ€™authentification (auth.users) et tes tables personnalisÃ©es (ex: profiles, friends).

Si tu crÃ©es un utilisateur via auth.signUp, mais que tu nâ€™insÃ¨res pas son profil dans ta table profiles, tu auras un dÃ©calage â†’ â€œnon synchronisÃ©â€.

RLS (Row Level Security)

Si tes politiques RLS bloquent la lecture/Ã©criture, lâ€™app ne peut pas rÃ©cupÃ©rer le profil.

RÃ©sultatâ€¯: lâ€™UI croit que le profil est â€œvideâ€ ou â€œnon synchronisÃ©â€.

Hooks manquants

Supabase ne crÃ©e pas automatiquement une ligne dans profiles quand tu ajoutes un utilisateur.

Il faut un trigger ou un edge function pour insÃ©rer le profil.

âœ… Comment corriger
1. VÃ©rifie ta table profiles
sql
select * from profiles where id = '<user_id>';
Si rien nâ€™apparaÃ®t â†’ le profil nâ€™est jamais insÃ©rÃ©.

2. Ajoute un trigger automatique
Dans Supabase SQL Editor :

sql
create function handle_new_user() returns trigger as $$
begin
  insert into profiles (id, username, created_at)
  values (new.id, new.email, now());
  return new;
end;
$$ language plpgsql security definer;

create trigger on_auth_user_created
after insert on auth.users
for each row execute procedure handle_new_user();
ğŸ‘‰ Chaque nouvel utilisateur aura une ligne dans profiles.

3. VÃ©rifie tes RLS policies
Exemple pour profiles :

sql
-- Lecture : lâ€™utilisateur peut voir son propre profil
create policy "Read own profile"
on profiles for select
using (auth.uid() = id);

-- Ã‰criture : lâ€™utilisateur peut modifier son profil
create policy "Update own profile"
on profiles for update
using (auth.uid() = id);
4. CÃ´tÃ© client
Quand tu ajoutes un ami, assureâ€‘toi dâ€™utiliser lâ€™id du profil et pas seulement lâ€™auth.user.id.

ts
const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", user.id)
  .single();

if (!profile) {
  throw new Error("Profil utilisateur non synchronisÃ©");
}
ğŸš€ RÃ©sumÃ©
Erreur = profil manquant ou bloquÃ© par RLS.

Solution = crÃ©er automatiquement la ligne profiles Ã  la crÃ©ation dâ€™un utilisateur + vÃ©rifier les policies.

Ensuite, tes fonctions â€œajouter un amiâ€ fonctionneront car elles trouveront bien le profil.